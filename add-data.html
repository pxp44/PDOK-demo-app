<!DOCTYPE html>
<html>
<!--

https://github.com/tomtor/PDOK-demo-app

-->
<head>
<title>PDOK Leaflet Example</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<!--
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
-->
<link rel="stylesheet" href="leaflet.css" />
</head>
<body>
<div id="map" style="width: 100%; height: 750px"></div>
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="http://rawgithub.com/kartena/Proj4Leaflet/master/lib/proj4-compressed.js"></script>
<script src="http://v7f.eu/public/PDOK/proj4leaflet.js"></script>
<script>
	var serverBase = 'http://v7f.eu/pdok-demo-data';
	var server = serverBase + '/d89d5ee2-d347-11e5-9d78-bcaec5c2cce2';

	var res = [3440.640, 1720.320, 860.160, 430.080, 215.040, 107.520, 53.760, 26.880, 13.440, 6.720, 3.360, 1.680, 0.840, 0.420];

	var RDM = new L.Proj.CRS.TMS(
		'EPSG:28992',
		'+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +towgs84=565.2369,50.0087,465.658,-0.406857330322398,0.350732676542563,-1.8703473836068,4.0812 +no_defs', [-285401.92, 22598.08, 595401.9199999999, 903401.9199999999], 
	{
		transformation: new L.Transformation(1,0,-1,0),
		resolutions: res
	});

	var map = L.map('map', {crs:RDM}).setView([52.15, 5.2], 3);

	L.tileLayer('http://geodata.nationaalgeoregister.nl/tms/1.0.0/brtachtergrondkaart/{z}/{x}/{y}.png', {
		tms: true,
		minZoom: 2,
		maxZoom: 12,
		attribution: '<a href="https://github.com/tomtor/PDOK-demo-app">DemoMap</a> Map data &copy; <a href="http://pdok.nl">PDOK</a>',
		id: 'brtachtergrondkaart'
	}).addTo(map);

	var popup = L.popup();

	$.ajax({url: server+"/get/", success: function(result){ markersReceived(result) }});

	function markersReceived(result) {
		var geojsonMarkerOptions = {
			radius: 8,
			color: "#000",
			weight: 1,
			opacity: 1,
			fillOpacity: 0.4
		};
		var plotlist= result;
		for (i= 0; i < plotlist.length; i++) {
			try {
				pu = "<small>uuid: " + plotlist[i].properties.uuid + "<br/>" +
					"timestamp: " + plotlist[i].properties.timestamp + "<br/>" +
					"IP info: " + plotlist[i].properties.ip_info + "<br/>" +
					"</small><br/>" +
					"Name: <b>" + plotlist[i].properties.name + "</b><br/>" +
					"Object type: <b>" + plotlist[i].properties.kind + "</b>";
				L.geoJson(plotlist[i], {
					pointToLayer: function (feature, latlng) {
						if (plotlist[i].properties.kind == "Animal") 
							geojsonMarkerOptions.fillColor= "#ff0000";
						else if (plotlist[i].properties.kind == "Tree") 
							geojsonMarkerOptions.fillColor= "#00ff00";
						else if (plotlist[i].properties.kind == "Building") 
							geojsonMarkerOptions.fillColor= "#0000ff";
						else
							geojsonMarkerOptions.fillColor= "#ffffff";
						return L.circleMarker(latlng, geojsonMarkerOptions);
					}
				}).addTo(map).bindPopup(pu);
			}
			catch (err) {
			}
		}
	}

	markers = {};
	function delObject(key) {
		$.ajax({url: server+"/delete/"+key});
		map.closePopup();
		var marker= markers[key];
		map.removeLayer(marker);
	}

	function onMapClick(e) {
		var pu = "Marker at <b>" + e.latlng + "</b>" +
			"<br />Name: <input id=\"nameInput\" type=\"text\"/><br/><br/>" +
			"<select id=\"selInput\">" +
				"<option value=\"Animal\">Animal</option>" +
				"<option value=\"Tree\">Tree</option>" +
				"<option value=\"Building\">Building</option>" +
			"</select><br/>" +
			"<br/><input id=\"addButton\" type=\"button\" value=\"Add\"/>";
		var mark = L.marker(e.latlng);
		mark.addTo(map).bindPopup(pu).openPopup();

		$("#addButton").click(function(event) {
			var gjf = {
				"type": "Feature",
				"geometry": {
					"type": "Point",
					"coordinates": [ e.latlng.lng , e.latlng.lat ]
				},
				"properties" : {
					"name" : document.getElementById("nameInput").value,
					"kind" : document.getElementById("selInput").value
				}
			};

			map.closePopup();
			var msg= server + '/add/' + JSON.stringify(gjf);
			$.ajax({url: msg, success: function(result){
				var pu = "<small>Secret Key: " + result + "</small><br/>Name: <b>" + gjf.properties.name + "</b><br/>" +
				"Object type: <b>" +  gjf.properties.kind + "</b>" +
				"<br/><br/><input id=\"delButton\" onclick=\"delObject('"+result+"')\" type=\"button\" value=\"Delete\"/>";
				markers[result]= mark;
				mark.addTo(map).bindPopup(pu);
				$("#keyTable").append("<tr id='"+result+"'><td>"+result+"</td></tr>");
			}})
		});
	}

	map.on('click', onMapClick);

</script>
<br/>
<small>
<div style="height: 70px; border: 1px solid blue; overflow: auto;">
<table id="keyTable">
<b>Added Objects</b>, save these keys if you want to delete them later...
</table>
</div>
</small>

<p>This demo shows how to add data to a Leaflet map layer.</p>

<p>On each mouse click a new object is added to the map and made visible for every visitor.<br/>
You can delete them in the same session as long as you don't refresh the page.</p>

<p>The data is stored in an SqlLite or PostgreSQL server database, it is 
cleared every day...</p>
<hr/>
<h2>Create your own database by entering your eMail:</h2>
Mail: <input id="eMail" type="text"><br/>
<br/><input id="eMailButton" type="submit"/>
<script>
var button = document.getElementById("eMailButton");
button.onclick = function() {
	var msg= serverBase + '/create/' + document.getElementById("eMail").value;
	ajaxRequest.onreadystatechange = null;
	ajaxRequest.open('GET', msg, true);
	ajaxRequest.send(null);
	document.getElementById("eMail").value= "Read your mail...";
}
</script>

</body>
</html>
